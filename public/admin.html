<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot Admin Panel</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .users-list, .history-list, .blocked-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 10px 0;
        }
        .user-item, .history-item, .blocked-item { 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
        }
        .user-item:hover, .blocked-item:hover { background: #f8f9fa; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        .btn-kick { background: #dc3545; color: white; }
        .btn-block { background: #ffc107; color: black; }
        .btn-unblock { background: #17a2b8; color: white; }
        .btn-broadcast { background: #007bff; color: white; }
        .btn-refresh { background: #28a745; color: white; }
        input, textarea { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 10px 0;
        }
        .stat-item { 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: center;
        }
        .tab-container {
            margin: 20px 0;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .tab-button.active {
            background: white;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        .security-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ Medical Chatbot Admin Panel - Enhanced Security</h1>
        
        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            ğŸ”´ Disconnected
        </div>

        <!-- Connection Form -->
        <div id="connectionForm">
            <h3>Connect as Admin</h3>
            <input type="text" id="serverUrl" placeholder="Server URL" value="http://localhost:10000">
            <input type="password" id="adminSecret" placeholder="Admin Secret" value="render-enhanced-secret-2024">
            <button onclick="connectAsAdmin()" class="btn-refresh">ğŸ”“ Connect as Admin</button>
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
                    <button class="tab-button" onclick="showTab('users')">ğŸ‘¥ Users</button>
                    <button class="tab-button" onclick="showTab('blocked')">â›” Blocked</button>
                    <button class="tab-button" onclick="showTab('history')">ğŸ’¬ History</button>
                    <button class="tab-button" onclick="showTab('security')">ğŸ”’ Security</button>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h3>Server Dashboard</h3>
                    
                    <!-- Server Stats -->
                    <div class="stats" id="serverStats">
                        <div class="stat-item">ğŸ“Š Loading...</div>
                    </div>

                    <!-- Quick Actions -->
                    <div>
                        <h4>ğŸš€ Quick Actions</h4>
                        <button onclick="refreshAll()" class="btn-refresh">ğŸ”„ Refresh All Data</button>
                        <button onclick="getBlockedList()" class="btn-refresh">ğŸ“‹ Refresh Blocked List</button>
                    </div>

                    <!-- Broadcast Message -->
                    <div>
                        <h4>ğŸ“¢ Broadcast Message</h4>
                        <textarea id="broadcastMessage" placeholder="Enter message to broadcast to all users..." rows="3"></textarea>
                        <button onclick="broadcastMessage()" class="btn-broadcast">ğŸ“¤ Broadcast to All Users</button>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="users" class="tab-content">
                    <h3>Connected Users (<span id="usersCount">0</span>)</h3>
                    <div class="users-list" id="usersList">
                        <div>No users connected</div>
                    </div>
                    <button onclick="refreshUsers()" class="btn-refresh">ğŸ”„ Refresh Users</button>
                </div>

                <!-- Blocked Tab -->
                <div id="blocked" class="tab-content">
                    <h3>Blocked Users & IPs</h3>
                    
                    <!-- Manual Block -->
                    <div style="margin-bottom: 20px;">
                        <h4>ğŸ”§ Manual Block</h4>
                        <input type="text" id="manualBlockTarget" placeholder="Enter Socket ID or IP to block">
                        <input type="text" id="manualBlockReason" placeholder="Reason for blocking">
                        <button onclick="manualBlock()" class="btn-block">â›” Block Target</button>
                    </div>

                    <!-- Blocked Lists -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4>ğŸ” Blocked IPs (<span id="blockedIPsCount">0</span>)</h4>
                            <div class="blocked-list" id="blockedIPsList">
                                <div>No blocked IPs</div>
                            </div>
                        </div>
                        <div>
                            <h4>ğŸš« Blocked Users (<span id="blockedUsersCount">0</span>)</h4>
                            <div class="blocked-list" id="blockedUsersList">
                                <div>No blocked users</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="getBlockedList()" class="btn-refresh">ğŸ”„ Refresh Blocked List</button>
                </div>

                <!-- History Tab -->
                <div id="history" class="tab-content">
                    <h3>Chat History & Security Logs</h3>
                    <div class="history-list" id="chatHistory">
                        <div>No chat history</div>
                    </div>
                    <button onclick="refreshHistory()" class="btn-refresh">ğŸ”„ Refresh History</button>
                </div>

                <!-- Security Tab -->
                <div id="security" class="tab-content">
                    <h3>Security Monitoring</h3>
                    
                    <div class="security-alert">
                        <strong>ğŸ”’ Enhanced Security Features Active</strong>
                        <ul>
                            <li>âœ… Rate Limiting</li>
                            <li>âœ… Input Validation</li>
                            <li>âœ… HTML Sanitization</li>
                            <li>âœ… NoSQL Injection Protection</li>
                            <li>âœ… Enhanced CORS</li>
                        </ul>
                    </div>

                    <!-- Security Stats -->
                    <div class="stats" id="securityStats">
                        <div class="stat-item">ğŸ›¡ï¸ Loading security stats...</div>
                    </div>

                    <!-- Rate Limit Monitoring -->
                    <div>
                        <h4>ğŸ“ˆ Rate Limit Monitoring</h4>
                        <div id="rateLimitInfo">
                            Loading rate limit information...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let currentStats = {};

        function connectAsAdmin() {
            const serverUrl = document.getElementById('serverUrl').value;
            const adminSecret = document.getElementById('adminSecret').value;

            // Disconnect existing connection
            if (socket) {
                socket.disconnect();
            }

            // Connect with admin secret
            socket = io(serverUrl, {
                auth: {
                    secret: adminSecret
                },
                transports: ['websocket', 'polling']
            });

            // Connection events
            socket.on('connect', () => {
                updateStatus('ğŸŸ¢ Connected as Admin - Enhanced Security', 'connected');
                document.getElementById('adminControls').style.display = 'block';
                console.log('Connected as admin with enhanced security');
            });

            socket.on('disconnect', (reason) => {
                updateStatus('ğŸ”´ Disconnected: ' + reason, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
            });

            socket.on('connect_error', (error) => {
                updateStatus('ğŸ”´ Connection Error: ' + error.message, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
                alert('Connection failed: ' + error.message);
            });

            // Admin-specific events
            socket.on('admin_welcome', (data) => {
                console.log('Admin welcome:', data);
                showNotification('âœ… ' + data.message);
                refreshAll();
            });

            socket.on('admin_users_update', (data) => {
                updateUsersList(data.users);
                updateStats(data.stats);
                updateSecurityStats(data.security);
            });

            socket.on('admin_stats', (stats) => {
                updateStats(stats);
                currentStats = stats;
            });

            socket.on('admin_chat_history', (history) => {
                updateChatHistory(history);
            });

            socket.on('admin_blocked_list', (blockedList) => {
                updateBlockedLists(blockedList);
            });

            socket.on('admin_action_result', (result) => {
                showNotification('âœ… ' + result.message);
                if (result.action === 'kick_user' || result.action === 'block_user' || result.action === 'unblock') {
                    refreshUsers();
                    getBlockedList();
                }
            });
        }

        function updateStatus(message, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${className}`;
        }

        function updateUsersList(users) {
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div>No users connected</div>';
                usersCount.textContent = '0';
                return;
            }

            usersCount.textContent = users.length;
            usersList.innerHTML = users.map(user => `
                <div class="user-item">
                    <strong>Socket ID:</strong> ${user.socketId}<br>
                    <strong>IP:</strong> ${user.ip}<br>
                    <strong>Connected:</strong> ${user.connectionTime}<br>
                    <strong>Messages:</strong> ${user.messageCount || 0}<br>
                    <strong>Status:</strong> ${user.isBlocked ? 'â›” BLOCKED' : 'âœ… Active'}<br>
                    <button onclick="kickUser('${user.socketId}')" class="btn-kick">ğŸš« Kick</button>
                    <button onclick="blockUser('${user.socketId}')" class="btn-block">â›” Block</button>
                </div>
            `).join('');
        }

        function updateStats(stats) {
            const statsElement = document.getElementById('serverStats');
            statsElement.innerHTML = `
                <div class="stat-item">
                    <strong>ğŸ‘¥ Connected Users</strong><br>
                    ${stats.totalConnections}
                </div>
                <div class="stat-item">
                    <strong>ğŸ’¬ Chat History</strong><br>
                    ${stats.chatHistorySize} messages
                </div>
                <div class="stat-item">
                    <strong>â›” Blocked IPs</strong><br>
                    ${stats.blockedIPs}
                </div>
                <div class="stat-item">
                    <strong>ğŸš« Blocked Users</strong><br>
                    ${stats.blockedUsers}
                </div>
                <div class="stat-item">
                    <strong>â° Server Uptime</strong><br>
                    ${Math.floor(stats.serverUptime / 60)}m ${Math.floor(stats.serverUptime % 60)}s
                </div>
                <div class="stat-item">
                    <strong>ğŸ“… Last Update</strong><br>
                    ${new Date(stats.timestamp).toLocaleTimeString()}
                </div>
            `;
        }

        function updateSecurityStats(security) {
            if (!security) return;
            
            const securityStats = document.getElementById('securityStats');
            securityStats.innerHTML = `
                <div class="stat-item">
                    <strong>ğŸ›¡ï¸ Blocked IPs</strong><br>
                    ${security.blockedIPs || 0}
                </div>
                <div class="stat-item">
                    <strong>ğŸš« Blocked Users</strong><br>
                    ${security.blockedUsers || 0}
                </div>
                <div class="stat-item">
                    <strong>ğŸ“ˆ Rate Limited IPs</strong><br>
                    ${security.rateLimitedIPs || 0}
                </div>
            `;
        }

        function updateBlockedLists(blockedList) {
            // Update blocked IPs
            const blockedIPsList = document.getElementById('blockedIPsList');
            const blockedIPsCount = document.getElementById('blockedIPsCount');
            
            if (blockedList.ips.length === 0) {
                blockedIPsList.innerHTML = '<div>No blocked IPs</div>';
                blockedIPsCount.textContent = '0';
            } else {
                blockedIPsCount.textContent = blockedList.ips.length;
                blockedIPsList.innerHTML = blockedList.ips.map(ip => `
                    <div class="blocked-item">
                        <strong>IP:</strong> ${ip.ip}<br>
                        <strong>Reason:</strong> ${ip.reason}<br>
                        <strong>Since:</strong> ${new Date(ip.timestamp).toLocaleString()}<br>
                        <button onclick="unblockTarget('${ip.ip}')" class="btn-unblock">ğŸ”“ Unblock</button>
                    </div>
                `).join('');
            }

            // Update blocked users
            const blockedUsersList = document.getElementById('blockedUsersList');
            const blockedUsersCount = document.getElementById('blockedUsersCount');
            
            if (blockedList.users.length === 0) {
                blockedUsersList.innerHTML = '<div>No blocked users</div>';
                blockedUsersCount.textContent = '0';
            } else {
                blockedUsersCount.textContent = blockedList.users.length;
                blockedUsersList.innerHTML = blockedList.users.map(user => `
                    <div class="blocked-item">
                        <strong>Socket ID:</strong> ${user.socketId}<br>
                        <strong>Reason:</strong> ${user.reason}<br>
                        <strong>Since:</strong> ${new Date(user.timestamp).toLocaleString()}<br>
                        <button onclick="unblockTarget('${user.socketId}')" class="btn-unblock">ğŸ”“ Unblock</button>
                    </div>
                `).join('');
            }
        }

        function updateChatHistory(history) {
            const historyElement = document.getElementById('chatHistory');
            
            if (history.length === 0) {
                historyElement.innerHTML = '<div>No chat history</div>';
                return;
            }

            historyElement.innerHTML = history.slice().reverse().map(entry => {
                let typeIcon = 'ğŸ’¬';
                if (entry.type === 'security_alert') typeIcon = 'ğŸš¨';
                if (entry.type === 'admin_action') typeIcon = 'ğŸ”§';
                if (entry.type === 'user_connected') typeIcon = 'ğŸ”Œ';
                if (entry.type === 'user_disconnected') typeIcon = 'ğŸ”´';
                
                return `
                    <div class="history-item">
                        <strong>${typeIcon} [${entry.timestampReadable}]</strong><br>
                        <strong>Socket:</strong> ${entry.socketId}<br>
                        <strong>Type:</strong> ${entry.type}<br>
                        <strong>Content:</strong> ${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}
                    </div>
                `;
            }).join('');
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Admin actions
        function kickUser(socketId) {
            if (confirm(`Are you sure you want to kick user ${socketId}?`)) {
                socket.emit('admin_kick_user', { socketId });
            }
        }

        function blockUser(socketId) {
            const reason = prompt('Enter reason for blocking:', 'Violation of terms');
            if (reason !== null) {
                socket.emit('admin_block_user', { socketId, reason });
            }
        }

        function manualBlock() {
            const target = document.getElementById('manualBlockTarget').value.trim();
            const reason = document.getElementById('manualBlockReason').value.trim() || 'Manual block by admin';
            
            if (!target) {
                alert('Please enter a Socket ID or IP to block');
                return;
            }
            
            if (confirm(`Are you sure you want to block ${target}?`)) {
                socket.emit('admin_manual_block', { socketId: target, reason });
                document.getElementById('manualBlockTarget').value = '';
                document.getElementById('manualBlockReason').value = '';
            }
        }

        function unblockTarget(target) {
            if (confirm(`Are you sure you want to unblock ${target}?`)) {
                socket.emit('admin_unblock', { target });
            }
        }

        function broadcastMessage() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message to broadcast');
                return;
            }
            
            if (confirm('Are you sure you want to broadcast this message to all users?')) {
                socket.emit('admin_broadcast', { message });
                document.getElementById('broadcastMessage').value = '';
            }
        }

        // Refresh functions
        function refreshAll() {
            refreshUsers();
            refreshStats();
            refreshHistory();
            getBlockedList();
        }

        function refreshUsers() {
            socket.emit('admin_get_stats');
        }

        function refreshStats() {
            socket.emit('admin_get_stats');
        }

        function refreshHistory() {
            socket.emit('admin_get_history');
        }

        function getBlockedList() {
            socket.emit('admin_get_blocked');
        }

        function showNotification(message) {
            // Simple notification - you can replace with a better notification system
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 1000;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // Auto-connect if values are present
        window.onload = function() {
            const secret = document.getElementById('adminSecret').value;
            if (secret) {
                setTimeout(() => {
                    connectAsAdmin();
                }, 1000);
            }
        };
    </script>
</body>
</html>
